<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>TimeSaver ‚Äî –û–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --primary: #0066ff;
      --secondary: #00d2ff;
      --bg-light: #f9f9fb;
      --bg-dark: #121212;
      --card-light: #ffffff;
      --card-dark: #1f1f1f;
      --text-light: #ffffff;
      --text-dark: #333333;
      --radius: 15px;
      --shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      transition: background 0.3s, color 0.3s;
    }

    body.light {
      background: var(--bg-light);
      color: var(--text-dark);
    }

    body.dark {
      background: var(--bg-dark);
      color: var(--text-light);
    }

    header {
      padding: 20px;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      text-align: center;
      border-bottom-left-radius: var(--radius);
      border-bottom-right-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .container {
      max-width: 800px;
      margin: 30px auto;
      padding: 20px;
    }

    .card {
      background: var(--card-light);
      padding: 25px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 30px;
      transition: background 0.3s, color 0.3s;
      position: relative; /* Needed for back button positioning */
    }

    body.dark .card {
      background: var(--card-dark);
      color: var(--text-light);
    }

    h1, h2, h3 {
      margin-top: 0;
    }

    input, select, button, textarea {
      width: 100%;
      padding: 12px 16px;
      margin-top: 10px;
      margin-bottom: 20px;
      border-radius: var(--radius);
      border: 1px solid #ccc;
      font-size: 16px;
      box-shadow: var(--shadow);
      outline: none;
    }

    button {
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
    }

    button:hover {
      background: var(--secondary);
      transform: scale(1.02);
    }

    .screen {
      display: none;
    }

    .active-screen {
      display: block; /* This class ensures the screen is visible */
    }

    .lang-theme {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .lang-theme select {
      flex: 1;
    }

    #logoPreview {
      max-height: 120px;
      display: block;
      margin-top: 10px;
      border-radius: var(--radius);
    }

    .buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    /* Styles for interactive stars */
    #starRating span {
      font-size: 30px;
      cursor: pointer;
      color: gray; /* Default color for unselected stars */
      transition: color 0.2s;
    }
    #starRating span.selected {
      color: gold; /* Color for selected stars */
    }

    /* Back button style */
    .back-button {
      position: absolute;
      top: 15px;
      left: 15px;
      background: #ccc;
      color: #333;
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: var(--shadow);
      z-index: 10;
      transition: background 0.2s;
    }
    .back-button:hover {
      background: #bbb;
    }

    /* Style for business list items and delete button */
    .business-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }
    .business-list-item button:first-child { /* The business selection button */
        flex-grow: 1;
    }
    .delete-business-button {
        background: #f44336; /* Red color for delete */
        color: white;
        border: none;
        border-radius: 50%; /* Make it round */
        width: 25px; /* Smaller width */
        height: 25px; /* Smaller height */
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0; /* Prevent shrinking */
        cursor: pointer;
        outline: none;
    }
    .delete-business-button:hover {
        background: #d32f2f;
    }

    /* Modal for confirmation */
    .confirmation-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .confirmation-modal-content {
        background: var(--card-light);
        padding: 30px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        text-align: center;
        max-width: 300px;
        width: 90%;
    }
    .confirmation-modal-content button {
        width: auto;
        padding: 10px 20px;
        margin: 10px;
    }
    .confirmation-modal-content button.cancel {
        background: #6c757d;
    }
    .confirmation-modal-content button.cancel:hover {
        background: #5a6268;
    }

    /* Business Dashboard Layout */
    .business-dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Adjusted min-width for better fit */
      gap: 20px;
      margin-top: 20px;
    }

    .dashboard-section {
      border: 1px solid #eee;
      border-radius: var(--radius);
      padding: 15px;
      background: var(--bg-light); /* Lighter background for sections */
      transition: background 0.3s;
      overflow: hidden; /* Hide overflowing content when collapsed */
    }
    body.dark .dashboard-section {
      background: var(--card-dark);
    }

    .dashboard-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid #eee;
    }
    body.dark .dashboard-section-header {
      border-bottom: 1px solid #333;
    }

    .dashboard-section-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .dashboard-section.expanded .dashboard-section-content {
      max-height: 500px; /* Adjust as needed for content */
      transition: max-height 0.5s ease-in;
    }

    .dashboard-section-header h3 {
      margin: 0;
    }
    .dashboard-section-header .toggle-icon {
      font-size: 20px;
      transition: transform 0.3s;
    }
    .dashboard-section.expanded .toggle-icon {
      transform: rotate(90deg);
    }
    
    .settings-button-top-right {
        position: absolute;
        top: 20px;
        right: 20px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: var(--shadow);
        z-index: 5;
    }
    .settings-button-top-right:hover {
        background: var(--secondary);
    }

    /* Business Settings Modal */
    .business-settings-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1100; /* Higher z-index than other modals */
    }
    .business-settings-modal-content {
        background: var(--card-light);
        padding: 30px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        text-align: center;
        max-width: 400px;
        width: 90%;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .business-settings-modal-content button {
        margin: 0; /* Override margin from general button style */
    }
  </style>
</head>
<body class="light">
  <header>
    <h1>TimeSaver</h1>
    <p>–í–∞—à –∞—Å–∏—Å—Ç–µ–Ω—Ç –∑ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –∑–∞–ø–∏—Å–∞–º–∏</p>
  </header>

  <div class="container">

    <div id="welcomeScreen" class="screen card">
      <h1>üëã –í—ñ—Ç–∞—î–º–æ!</h1>
      <p>–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ –¥–æ TimeSaver ‚Äî –≤–∞—à–æ–≥–æ –ø–æ–º—ñ—á–Ω–∏–∫–∞ –¥–ª—è –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å—É –∫–ª—ñ—î–Ω—Ç—ñ–≤.</p>
      <button onclick="continueToHome()">–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</button>
    </div>

    <div id="homeScreen" class="screen card">
      <h2>üìã –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é</h2>
      <div class="buttons">
        <button onclick="showBusinesses()">üè¢ –ú–æ—ó –±—ñ–∑–Ω–µ—Å–∏</button>
        <button onclick="showScreen('settingsScreen')">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
        <button onclick="showScreen('feedbackScreen')">‚≠ê –ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫</button>
        <button onclick="alert('TimeSaver ‚Äî –¥–æ–¥–∞—Ç–æ–∫ –¥–ª—è –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å—É –∫–ª—ñ—î–Ω—Ç—ñ–≤. –£—Å—ñ –¥–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.\n\n–†–æ–∑—Ä–æ–±–Ω–∏–∫: –°–æ—Ä–æ–∫–∞ –û–ª–µ–∫—Å–∞–Ω–¥—Ä.')">‚ÑπÔ∏è –ü—Ä–æ –ø—Ä–æ–≥—Ä–∞–º—É</button>
      </div>
    </div>
    
    <div id="businessListScreen" class="screen card">
      <button class="back-button" onclick="goBack()">&#8592;</button> 
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>üè¢ –ú–æ—ó –±—ñ–∑–Ω–µ—Å–∏</h2>
        <button onclick="showCreateBusinessModal()" style="font-size: 24px; padding: 2px 10px;">‚ûï</button>
      </div>
      <div id="businessList"></div>
      <br>
    </div>

    <div id="businessDashboard" class="screen card">
      <button class="back-button" onclick="goBack()">&#8592;</button>
      <button class="settings-button-top-right" onclick="showBusinessSettingsModal()">‚öôÔ∏è</button>
      
      <h2 id="businessDashboardName" style="text-align: center;">–ú–µ–Ω—é –±—ñ–∑–Ω–µ—Å—É</h2>
      <img id="businessDashboardLogo" src="" alt="–õ–æ–≥–æ—Ç–∏–ø –±—ñ–∑–Ω–µ—Å—É" style="max-height: 100px; margin: 0 auto 15px; display: none; border-radius: var(--radius);">
      <p style="text-align: center;">–¢–∏–ø –±—ñ–∑–Ω–µ—Å—É: <span id="businessDashboardType"></span></p>

      <div class="business-dashboard-grid">
        <div id="servicesSection" class="dashboard-section">
          <div class="dashboard-section-header" onclick="toggleSection('servicesSection')">
            <h3>üíº –ü–æ—Å–ª—É–≥–∏</h3>
            <span class="toggle-icon">‚ñ∂</span>
          </div>
          <div class="dashboard-section-content">
            <ul id="businessServicesList" style="list-style: none; padding: 0;">
              <li>(–°–ø–∏—Å–æ–∫ –ø–æ—Å–ª—É–≥ –ø–æ—Ä–æ–∂–Ω—ñ–π)</li>
            </ul>
            <button onclick="showAddServiceScreen()" style="margin-top: 10px;">‚ûï –î–æ–¥–∞—Ç–∏ –ø–æ—Å–ª—É–≥—É</button>
          </div>
        </div>

        <div id="clientsSection" class="dashboard-section">
          <div class="dashboard-section-header" onclick="toggleSection('clientsSection')">
            <h3>üë• –ö–ª—ñ—î–Ω—Ç–∏</h3>
            <span class="toggle-icon">‚ñ∂</span>
          </div>
          <div class="dashboard-section-content">
            <ul id="businessClientsList" style="list-style: none; padding: 0;">
              <li>(–°–ø–∏—Å–æ–∫ –∫–ª—ñ—î–Ω—Ç—ñ–≤ –ø–æ—Ä–æ–∂–Ω—ñ–π)</li>
            </ul>
            <button onclick="showAddClientScreen()" style="margin-top: 10px;">‚ûï –î–æ–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞</button>
          </div>
        </div>

        <div id="scheduleSection" class="dashboard-section">
          <div class="dashboard-section-header" onclick="toggleSection('scheduleSection')">
            <h3>üïí –†–æ–∑–∫–ª–∞–¥</h3>
            <span class="toggle-icon">‚ñ∂</span>
          </div>
          <div class="dashboard-section-content">
            <div id="businessScheduleContent">
              <p>–û—Å—å —Ä–æ–∑–∫–ª–∞–¥ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ:</p>
              <ul id="todayScheduleList" style="list-style: none; padding: 0;">
                  <li>(–ü–æ–∫–∏ –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤)</li>
              </ul>
            </div>
            <button onclick="showScheduleScreen()" style="margin-top: 10px;">üóìÔ∏è –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –ø–æ–≤–Ω–∏–π —Ä–æ–∑–∫–ª–∞–¥</button>
          </div>
        </div>
      </div>
    </div>

    <div id="createBusinessModal" class="screen card" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); z-index:999; background:white; box-shadow:0 0 15px rgba(0,0,0,0.3);">
      <h3>‚ûï –î–æ–¥–∞—Ç–∏ –±—ñ–∑–Ω–µ—Å</h3>
      <label>–¢–∏–ø –±—ñ–∑–Ω–µ—Å—É: <input id="businessType" type="text"></label><br><br>
      <label>–ù–∞–∑–≤–∞ –±—ñ–∑–Ω–µ—Å—É: <input id="businessName" type="text"></label><br><br>
      <label>–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ: <input id="logoInput" type="file" accept="image/*"></label><br><br>
      <img id="logoPreview" src="" alt="–ü—Ä–µ–≤'—é" style="max-width:100px; display:none;"><br><br>
      <button onclick="saveBusinessInfo()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
      <button onclick="document.getElementById('createBusinessModal').style.display='none'">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    </div>

    <div id="feedbackScreen" class="screen card">
      <button class="back-button" onclick="goBack()">&#8592;</button> 
      <h2>‚≠ê –ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫</h2>
      <p>–û—Ü—ñ–Ω—ñ—Ç—å –¥–æ–¥–∞—Ç–æ–∫:</p>
      <div id="starRating">
        <span data-value="1">‚≠ê</span>
        <span data-value="2">‚≠ê</span>
        <span data-value="3">‚≠ê</span>
        <span data-value="4">‚≠ê</span>
        <span data-value="5">‚≠ê</span>
      </div>
      <br>
      <textarea id="feedbackText" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å —Å–≤—ñ–π –≤—ñ–¥–≥—É–∫" style="width:100%; height:100px;"></textarea>
      <br><br>
      <button onclick="submitFeedback()">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
    </div>

    <div id="settingsScreen" class="screen card">
      <button class="back-button" onclick="goBack()">&#8592;</button> 
      <h2>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
      <div class="lang-theme">
        <div style="flex:1">
          <label>–ú–æ–≤–∞ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É:</label>
          <select id="languageSelect">
            <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
            <option value="en">English</option>
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
          </select>
        </div>
        <div style="flex:1">
          <label>–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è:</label>
          <select id="themeSelect">
            <option value="light">–°–≤—ñ—Ç–ª–∞</option>
            <option value="dark">–¢–µ–º–Ω–∞</option>
          </select>
        </div>
      </div>
      <button onclick="saveSettings()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
    </div>
    
    <div id="addClientScreen" class="screen card">
      <button class="back-button" onclick="goBack()">&#8592;</button>
      <h2>‚ûï –î–æ–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞</h2>
      <label>–Ü–º'—è –∫–ª—ñ—î–Ω—Ç–∞: <input type="text" id="clientName"></label>
      <label>–¢–µ–ª–µ—Ñ–æ–Ω: <input type="tel" id="clientPhone"></label>
      <label>–ü—Ä–∏–º—ñ—Ç–∫–∏: <textarea id="clientNotes"></textarea></label>
      <button onclick="saveClient()">–ó–±–µ—Ä–µ–≥—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞</button>
    </div>

    <div id="addServiceScreen" class="screen card">
      <button class="back-button" onclick="goBack()">&#8592;</button>
      <h2>üíº –î–æ–¥–∞—Ç–∏ –ø–æ—Å–ª—É–≥—É</h2>
      <label>–ù–∞–∑–≤–∞ –ø–æ—Å–ª—É–≥–∏: <input type="text" id="serviceName"></label>
      <label>–¶—ñ–Ω–∞: <input type="number" id="servicePrice" step="0.01"></label>
      <label>–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å (—Ö–≤): <input type="number" id="serviceTime"></label>
      <button onclick="saveService()">–ó–±–µ—Ä–µ–≥—Ç–∏ –ø–æ—Å–ª—É–≥—É</button>
    </div>

    <div id="scheduleScreen" class="screen card">
      <button class="back-button" onclick="goBack()">&#8592;</button>
      <h2>üïí –†–æ–∑–∫–ª–∞–¥</h2>
      <p>–¢—É—Ç –±—É–¥–µ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏—Å—è —Ä–æ–∑–∫–ª–∞–¥ –¥–ª—è <span id="scheduleBusinessName"></span>.</p>
      <div id="scheduleContent">
        <p>–ù–∞—Ä–∞–∑—ñ —Ä–æ–∑–∫–ª–∞–¥ —â–µ –Ω–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –ø–æ–≤–Ω–æ—Ü—ñ–Ω–Ω–æ. –í–∏ –º–æ–∂–µ—Ç–µ –¥–æ–¥–∞–≤–∞—Ç–∏ –Ω–æ–≤—ñ –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±—ñ–∑–Ω–µ—Å—É.</p>
        <h3>–ó–∞–ø–∏—Å–∏ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ (<span id="currentDate"></span>):</h3>
        <ul id="todayAppointmentsList">
          <li>(–ü–æ–∫–∏ –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤)</li>
        </ul>
        <button onclick="showAddAppointmentScreen()" style="margin-top: 15px;">‚ûï –î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å</button>
      </div>
    </div>

    <div id="addAppointmentScreen" class="screen card">
        <button class="back-button" onclick="goBack()">&#8592;</button>
        <h2>‚ûï –î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å</h2>
        <label>–î–∞—Ç–∞: <input type="date" id="appointmentDate"></label>
        <label>–ß–∞—Å: <input type="time" id="appointmentTime"></label>
        <label>–ö–ª—ñ—î–Ω—Ç:
            <select id="appointmentClientSelect">
                <option value="">–û–±–µ—Ä—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞</option>
                </select>
        </label>
        <label>–ü–æ—Å–ª—É–≥–∞:
            <select id="appointmentServiceSelect">
                <option value="">–û–±–µ—Ä—ñ—Ç—å –ø–æ—Å–ª—É–≥—É</option>
                </select>
        </label>
        <button onclick="saveAppointment()">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–∞–ø–∏—Å</button>
    </div>

    <div id="mainApp" class="screen card">
      <button class="back-button" onclick="goBack()">&#8592;</button>
      <h2>üìí –ü–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è</h2>
      <p>–¢—É—Ç –±—É–¥–µ —Å–∏—Å—Ç–µ–º–∞ –ø–æ—Å–ª—É–≥, —Ä–æ–∑–∫–ª–∞–¥—É —Ç–∞ –∫–ª—ñ—î–Ω—Ç—ñ–≤ (–¥–æ–¥–∞—î—Ç—å—Å—è –¥–∞–ª—ñ)</p>
    </div>

  </div>

  <div id="confirmationModal" class="confirmation-modal-overlay" style="display:none;">
      <div class="confirmation-modal-content">
          <p>–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ <span id="businessToDeleteName"></span>?</p>
          <button onclick="confirmDeleteBusiness(true)">–¢–∞–∫</button>
          <button onclick="confirmDeleteBusiness(false)" class="cancel">–ù—ñ</button>
      </div>
  </div>

  <div id="businessSettingsModal" class="business-settings-modal-overlay" style="display:none;">
      <div class="business-settings-modal-content">
          <h3>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±—ñ–∑–Ω–µ—Å—É</h3>
          <button onclick="showAddClientScreen()">‚ûï –î–æ–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞</button>
          <button onclick="showAddServiceScreen()">üíº –î–æ–¥–∞—Ç–∏ –ø–æ—Å–ª—É–≥—É</button>
          <button onclick="showScheduleScreen()">üïí –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Ä–æ–∑–∫–ª–∞–¥</button>
          <button class="cancel" onclick="document.getElementById('businessSettingsModal').style.display='none'">–ó–∞–∫—Ä–∏—Ç–∏</button>
      </div>
  </div>

  <script>
    const screens = [
      'welcomeScreen', 'homeScreen', 'businessListScreen', 'businessDashboard',
      'createBusinessModal', 'feedbackScreen', 'settingsScreen', 'mainApp',
      'addClientScreen', 'addServiceScreen', 'scheduleScreen', 'confirmationModal',
      'businessSettingsModal', 'addAppointmentScreen' // Added new screens
    ];
    let currentRating = 0;
    let screenHistory = [];
    let selectedBusinessIndex = -1; // To keep track of the currently selected business
    let businessIndexToDelete = -1; // To store the index of the business to be deleted

    let isGoingBack = false; // Flag to indicate if navigation is a 'goBack' operation

    function showScreen(id) {
      const currentActiveScreen = document.querySelector('.screen.active-screen');
      
      // Only push to history if we are NOT going back and it's a new screen (not a modal)
      // And also not pushing modal overlays or self-navigating screens
      if (currentActiveScreen && currentActiveScreen.id !== 'createBusinessModal' && 
          currentActiveScreen.id !== 'confirmationModal' && 
          currentActiveScreen.id !== 'businessSettingsModal' &&
          currentActiveScreen.id !== id && !isGoingBack) {
          screenHistory.push(currentActiveScreen.id);
      }
      
      // Clear the isGoingBack flag after it's been used
      if (isGoingBack) {
          isGoingBack = false;
      }

      screens.forEach(screenId => {
        const screenElement = document.getElementById(screenId);
        if (screenElement) {
          screenElement.style.display = "none";
          screenElement.classList.remove('active-screen'); // Ensure active-screen is removed
        }
      });
      
      const targetScreen = document.getElementById(id);
      if (targetScreen) {
        targetScreen.style.display = "block";
        // Do not add active-screen class to modal overlays
        if (id !== 'createBusinessModal' && id !== 'confirmationModal' && id !== 'businessSettingsModal') {
            targetScreen.classList.add('active-screen'); 
        }
        // Specific actions when showing certain screens
        if (id === 'businessDashboard') {
          loadBusinessDashboardData(); // Load services and clients when dashboard is shown
        } else if (id === 'addAppointmentScreen') {
          populateAppointmentForm();
        } else if (id === 'scheduleScreen') {
            displayScheduleForToday();
        }
      }
    }

    function goBack() {
      if (screenHistory.length > 0) {
        isGoingBack = true; // Set flag before calling showScreen
        const lastScreenId = screenHistory.pop();
        showScreen(lastScreenId);
      } else {
        // If no history, go to home screen (or welcome, depending on app logic)
        showScreen('homeScreen'); // Default fallback if history is empty
      }
    }

    function saveSettings() {
      const lang = document.getElementById("languageSelect").value;
      const theme = document.getElementById("themeSelect").value;
      localStorage.setItem("settings", JSON.stringify({ lang, theme }));
      document.body.className = theme;
      alert("–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ!");
      showScreen('homeScreen');
    }

    function applySettings() {
      const settings = JSON.parse(localStorage.getItem("settings") || "{}");
      if (settings.theme) {
        document.body.className = settings.theme;
        document.getElementById("themeSelect").value = settings.theme;
      }
      if (settings.lang) {
        document.getElementById("languageSelect").value = settings.lang;
      }
    }
    
    function saveBusinessInfo() {
      const type = document.getElementById("businessType").value;
      const name = document.getElementById("businessName").value;
      const logo = document.getElementById("logoPreview").src;
      
      if (type && name) {
        const allBusinesses = JSON.parse(localStorage.getItem("allBusinesses") || "[]");
        // Initialize clients, services, and appointments arrays
        allBusinesses.push({ type, name, logo, clients: [], services: [], appointments: [] }); 
        localStorage.setItem("allBusinesses", JSON.stringify(allBusinesses));
        alert("–ë—ñ–∑–Ω–µ—Å —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ!");
        document.getElementById('createBusinessModal').style.display='none'; // Hide modal
        showBusinesses(); // Go to the business list after creation
      } else {
        alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è.");
      }
    }

    document.getElementById("logoInput").addEventListener("change", function () {
      const reader = new FileReader();
      reader.onload = function (e) {
        const preview = document.getElementById("logoPreview");
        preview.src = e.target.result;
        preview.style.display = "block";
      };
      reader.readAsDataURL(this.files[0]);
    });

    function showBusinesses() {
      const list = document.getElementById("businessList");
      list.innerHTML = "";
      const businesses = JSON.parse(localStorage.getItem("allBusinesses") || "[]");
      if (businesses.length === 0) {
        list.innerHTML = "<p>–ë—ñ–∑–Ω–µ—Å—ñ–≤ —â–µ –Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ.</p>";
      } else {
        businesses.forEach((biz, index) => {
          const listItem = document.createElement("div");
          listItem.classList.add("business-list-item");

          const bizButton = document.createElement("button");
          bizButton.innerText = biz.name + " (" + biz.type + ")";
          bizButton.onclick = () => openBusinessDashboard(index);
          listItem.appendChild(bizButton);

          const deleteButton = document.createElement("button");
          deleteButton.innerText = "‚úñ";
          deleteButton.classList.add("delete-business-button");
          deleteButton.onclick = (event) => {
              event.stopPropagation(); // Prevent opening dashboard when clicking delete
              showDeleteConfirmation(index, biz.name);
          };
          listItem.appendChild(deleteButton);
          list.appendChild(listItem);
        });
      }
      showScreen("businessListScreen");
    }

    function openBusinessDashboard(index) {
      const businesses = JSON.parse(localStorage.getItem("allBusinesses") || "[]");
      const biz = businesses[index];
      selectedBusinessIndex = index; // Set the currently selected business index
      
      document.getElementById("businessDashboardName").innerText = biz.name + " (–ú–µ–Ω—é –±—ñ–∑–Ω–µ—Å—É)";
      document.getElementById("businessDashboardType").innerText = biz.type;
      
      const logoElement = document.getElementById("businessDashboardLogo");
      if (biz.logo && biz.logo !== window.location.href) { // Check if logo exists and is not a default empty string
        logoElement.src = biz.logo;
        logoElement.style.display = "block";
      } else {
        logoElement.src = "";
        logoElement.style.display = "none";
      }

      showScreen("businessDashboard");
    }

    // New function to load data into dashboard sections
    function loadBusinessDashboardData() {
      const allBusinesses = JSON.parse(localStorage.getItem("allBusinesses") || "[]");
      if (selectedBusinessIndex === -1 || !allBusinesses[selectedBusinessIndex]) return;

      const currentBiz = allBusinesses[selectedBusinessIndex];

      // Load Services
      const servicesList = document.getElementById('businessServicesList');
      servicesList.innerHTML = '';
      if (currentBiz.services && currentBiz.services.length > 0) {
        currentBiz.services.forEach(service => {
          const li = document.createElement('li');
          li.innerText = `${service.name} (${service.price} –≥—Ä–Ω, ${service.time} —Ö–≤)`;
          servicesList.appendChild(li);
        });
      } else {
        servicesList.innerHTML = '<li>(–°–ø–∏—Å–æ–∫ –ø–æ—Å–ª—É–≥ –ø–æ—Ä–æ–∂–Ω—ñ–π)</li>';
      }

      // Load Clients
      const clientsList = document.getElementById('businessClientsList');
      clientsList.innerHTML = '';
      if (currentBiz.clients && currentBiz.clients.length > 0) {
        currentBiz.clients.forEach(client => {
          const li = document.createElement('li');
          li.innerText = `${client.name} (${client.phone})`;
          clientsList.appendChild(li);
        });
      } else {
        clientsList.innerHTML = '<li>(–°–ø–∏—Å–æ–∫ –∫–ª—ñ—î–Ω—Ç—ñ–≤ –ø–æ—Ä–æ–∂–Ω—ñ–π)</li>';
      }

      // Basic Schedule for today (can be expanded)
      const todayScheduleList = document.getElementById('todayScheduleList');
      todayScheduleList.innerHTML = '';
      const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
      document.getElementById('currentDate').innerText = today; // Update date in schedule section

      if (currentBiz.appointments && currentBiz.appointments.length > 0) {
          const todayAppointments = currentBiz.appointments.filter(appt => appt.date === today);
          if (todayAppointments.length > 0) {
              todayAppointments.sort((a, b) => a.time.localeCompare(b.time)); // Sort by time
              todayAppointments.forEach(appt => {
                  const li = document.createElement('li');
                  // Find client and service names
                  const client = currentBiz.clients.find(c => c.phone === appt.clientPhone);
                  const service = currentBiz.services.find(s => s.name === appt.serviceName); // Assuming serviceName is unique for simplicity

                  const clientName = client ? client.name : appt.clientPhone;
                  const serviceName = service ? service.name : appt.serviceName;

                  li.innerText = `${appt.time} - ${clientName} (${serviceName})`;
                  todayScheduleList.appendChild(li);
              });
          } else {
              todayScheduleList.innerHTML = '<li>(–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ)</li>';
          }
      } else {
          todayScheduleList.innerHTML = '<li>(–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤)</li>';
      }
    }

    // Toggle section (accordion behavior)
    function toggleSection(sectionId) {
        const section = document.getElementById(sectionId);
        section.classList.toggle('expanded');
    }


    function continueToHome() {
      showScreen("homeScreen");
    }

    function setRating(stars) {
      currentRating = stars; // Store the selected rating
      const spans = document.querySelectorAll("#starRating span");
      spans.forEach((s, i) => {
        if (i < stars) {
          s.classList.add("selected");
        } else {
          s.classList.remove("selected");
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
        const starRatingContainer = document.getElementById("starRating");
        if (starRatingContainer) {
            const stars = starRatingContainer.querySelectorAll("span");

            stars.forEach(star => {
                star.addEventListener('mouseover', () => {
                    const value = parseInt(star.dataset.value);
                    stars.forEach((s, i) => {
                        if (i < value) {
                            s.classList.add("selected");
                        } else {
                            s.classList.remove("selected");
                        }
                    });
                });

                star.addEventListener('mouseout', () => {
                    // Reset to currentRating when mouse leaves
                    stars.forEach((s, i) => {
                        if (i < currentRating) {
                            s.classList.add("selected");
                        } else {
                            s.classList.remove("selected");
                        }
                    });
                });

                star.addEventListener('click', () => {
                    setRating(parseInt(star.dataset.value));
                });
            });
        }
    });

    function submitFeedback() {
      const feedbackText = document.getElementById("feedbackText").value;
      if (currentRating === 0) {
        alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑—ñ—Ä–æ—á–æ–∫.");
        return;
      }
      if (feedbackText.trim() === "") {
        alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –Ω–∞–ø–∏—à—ñ—Ç—å —Å–≤—ñ–π –≤—ñ–¥–≥—É–∫.");
        return;
      }
      alert(`–î—è–∫—É—î–º–æ –∑–∞ –≤–∞—à –≤—ñ–¥–≥—É–∫! –í–∏ –æ—Ü—ñ–Ω–∏–ª–∏ –Ω–∞ ${currentRating} –∑—ñ—Ä–æ—á–æ–∫.`);
      document.getElementById("feedbackText").value = "";
      setRating(0); // Reset stars
      showScreen('homeScreen'); // Go back to home screen
    }

    function showCreateBusinessModal() {
      document.getElementById("createBusinessModal").style.display = "block";
      // Clear previous inputs when opening the modal
      document.getElementById("businessType").value = "";
      document.getElementById("businessName").value = "";
      document.getElementById("logoInput").value = ""; // Clear file input
      document.getElementById("logoPreview").src = "";
      document.getElementById("logoPreview").style.display = "none";
    }

    // --- Client Functions ---
    function showAddClientScreen() {
      document.getElementById('businessSettingsModal').style.display='none'; // Hide business settings modal if open
      showScreen('addClientScreen');
      // Clear previous inputs
      document.getElementById('clientName').value = '';
      document.getElementById('clientPhone').value = '';
      document.getElementById('clientNotes').value = '';
    }

    function saveClient() {
      const clientName = document.getElementById('clientName').value;
      const clientPhone = document.getElementById('clientPhone').value;
      const clientNotes = document.getElementById('clientNotes').value;

      if (!clientName || !clientPhone) {
        alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —ñ–º'—è —Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω –∫–ª—ñ—î–Ω—Ç–∞.");
        return;
      }

      const allBusinesses = JSON.parse(localStorage.getItem("allBusinesses") || "[]");
      if (selectedBusinessIndex !== -1 && allBusinesses[selectedBusinessIndex]) {
        const newClient = { name: clientName, phone: clientPhone, notes: clientNotes };
        allBusinesses[selectedBusinessIndex].clients.push(newClient);
        localStorage.setItem("allBusinesses", JSON.stringify(allBusinesses));
        alert("–ö–ª—ñ—î–Ω—Ç–∞ —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ!");
        goBack(); // Go back to business dashboard
      } else {
        alert("–ü–æ–º–∏–ª–∫–∞: –ë—ñ–∑–Ω–µ—Å –Ω–µ –≤–∏–±—Ä–∞–Ω–æ.");
      }
    }

    // --- Service Functions ---
    function showAddServiceScreen() {
      document.getElementById('businessSettingsModal').style.display='none'; // Hide business settings modal if open
      showScreen('addServiceScreen');
      // Clear previous inputs
      document.getElementById('serviceName').value = '';
      document.getElementById('servicePrice').value = '';
      document.getElementById('serviceTime').value = '';
    }

    function saveService() {
      const serviceName = document.getElementById('serviceName').value;
      const servicePrice = parseFloat(document.getElementById('servicePrice').value);
      const serviceTime = parseInt(document.getElementById('serviceTime').value);

      if (!serviceName || isNaN(servicePrice) || isNaN(serviceTime)) {
        alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è –¥–ª—è –ø–æ—Å–ª—É–≥–∏.");
        return;
      }
      if (servicePrice <= 0 || serviceTime <= 0) {
        alert("–¶—ñ–Ω–∞ —Ç–∞ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –ø–æ—Å–ª—É–≥–∏ –ø–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ –ø–æ–∑–∏—Ç–∏–≤–Ω–∏–º–∏ —á–∏—Å–ª–∞–º–∏.");
        return;
      }

      const allBusinesses = JSON.parse(localStorage.getItem("allBusinesses") || "[]");
      if (selectedBusinessIndex !== -1 && allBusinesses[selectedBusinessIndex]) {
        const newService = { name: serviceName, price: servicePrice, time: serviceTime };
        allBusinesses[selectedBusinessIndex].services.push(newService);
        localStorage.setItem("allBusinesses", JSON.stringify(allBusinesses));
        alert("–ü–æ—Å–ª—É–≥—É —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ!");
        goBack(); // Go back to business dashboard
      } else {
        alert("–ü–æ–º–∏–ª–∫–∞: –ë—ñ–∑–Ω–µ—Å –Ω–µ –≤–∏–±—Ä–∞–Ω–æ.");
      }
    }

    // --- Schedule Functions ---
    function showScheduleScreen() {
      document.getElementById('businessSettingsModal').style.display='none'; // Hide business settings modal if open
      const businesses = JSON.parse(localStorage.getItem("allBusinesses") || "[]");
      if (selectedBusinessIndex !== -1 && businesses[selectedBusinessIndex]) {
          document.getElementById('scheduleBusinessName').innerText = businesses[selectedBusinessIndex].name;
      } else {
          document.getElementById('scheduleBusinessName').innerText = "–Ω–µ–≤—ñ–¥–æ–º–∏–π –±—ñ–∑–Ω–µ—Å";
      }
      showScreen('scheduleScreen');
    }

    function showAddAppointmentScreen() {
        showScreen('addAppointmentScreen');
    }

    function populateAppointmentForm() {
        const allBusinesses = JSON.parse(localStorage.getItem("allBusinesses") || "[]");
        if (selectedBusinessIndex === -1 || !allBusinesses[selectedBusinessIndex]) return;

        const currentBiz = allBusinesses[selectedBusinessIndex];

        // Populate clients select
        const clientSelect = document.getElementById('appointmentClientSelect');
        clientSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞</option>';
        if (currentBiz.clients && currentBiz.clients.length > 0) {
            currentBiz.clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.phone; // Using phone as unique identifier
                option.innerText = client.name + (client.phone ? ` (${client.phone})` : '');
                clientSelect.appendChild(option);
            });
        }

        // Populate services select
        const serviceSelect = document.getElementById('appointmentServiceSelect');
        serviceSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –ø–æ—Å–ª—É–≥—É</option>';
        if (currentBiz.services && currentBiz.services.length > 0) {
            currentBiz.services.forEach(service => {
                const option = document.createElement('option');
                option.value = service.name; // Using name as unique identifier for simplicity
                option.innerText = `${service.name} (${service.price} –≥—Ä–Ω, ${service.time} —Ö–≤)`;
                serviceSelect.appendChild(option);
            });
        }

        // Set default date to today
        const today = new Date().toISOString().slice(0, 10);
        document.getElementById('appointmentDate').value = today;
        document.getElementById('appointmentTime').value = ''; // Clear time
    }

    function saveAppointment() {
        const date = document.getElementById('appointmentDate').value;
        const time = document.getElementById('appointmentTime').value;
        const clientPhone = document.getElementById('appointmentClientSelect').value;
        const serviceName = document.getElementById('appointmentServiceSelect').value;

        if (!date || !time || !clientPhone || !serviceName) {
            alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è –¥–ª—è –∑–∞–ø–∏—Å—É.");
            return;
        }

        const allBusinesses = JSON.parse(localStorage.getItem("allBusinesses") || "[]");
        if (selectedBusinessIndex !== -1 && allBusinesses[selectedBusinessIndex]) {
            const newAppointment = { date, time, clientPhone, serviceName };
            allBusinesses[selectedBusinessIndex].appointments.push(newAppointment);
            localStorage.setItem("allBusinesses", JSON.stringify(allBusinesses));
            alert("–ó–∞–ø–∏—Å —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ!");
            goBack(); // Go back to schedule screen
        } else {
            alert("–ü–æ–º–∏–ª–∫–∞: –ë—ñ–∑–Ω–µ—Å –Ω–µ –≤–∏–±—Ä–∞–Ω–æ.");
        }
    }

    function displayScheduleForToday() {
        const allBusinesses = JSON.parse(localStorage.getItem("allBusinesses") || "[]");
        if (selectedBusinessIndex === -1 || !allBusinesses[selectedBusinessIndex]) return;

        const currentBiz = allBusinesses[selectedBusinessIndex];
        const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
        document.getElementById('currentDate').innerText = today;

        const todayAppointmentsList = document.getElementById('todayAppointmentsList');
        todayAppointmentsList.innerHTML = '';

        if (currentBiz.appointments && currentBiz.appointments.length > 0) {
            const appointmentsToday = currentBiz.appointments.filter(appt => appt.date === today);
            if (appointmentsToday.length > 0) {
                appointmentsToday.sort((a, b) => a.time.localeCompare(b.time)); // Sort by time
                appointmentsToday.forEach(appt => {
                    const li = document.createElement('li');
                    // Find client and service names for display
                    const client = currentBiz.clients.find(c => c.phone === appt.clientPhone);
                    const service = currentBiz.services.find(s => s.name === appt.serviceName);

                    const clientName = client ? client.name : appt.clientPhone;
                    const serviceName = service ? service.name : appt.serviceName;

                    li.innerText = `${appt.time} - ${clientName} (${serviceName})`;
                    todayAppointmentsList.appendChild(li);
                });
            } else {
                todayAppointmentsList.innerHTML = '<li>(–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ)</li>';
            }
        } else {
            todayAppointmentsList.innerHTML = '<li>(–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤)</li>';
        }
    }


    // --- Delete Business Functions ---
    function showDeleteConfirmation(index, businessName) {
        businessIndexToDelete = index;
        document.getElementById('businessToDeleteName').innerText = businessName;
        document.getElementById('confirmationModal').style.display = 'flex'; // Show the modal
    }

    function confirmDeleteBusiness(isConfirmed) {
        document.getElementById('confirmationModal').style.display = 'none'; // Hide the modal

        if (isConfirmed && businessIndexToDelete !== -1) {
            let allBusinesses = JSON.parse(localStorage.getItem("allBusinesses") || "[]");
            allBusinesses.splice(businessIndexToDelete, 1); // Remove the business
            localStorage.setItem("allBusinesses", JSON.stringify(allBusinesses));
            alert("–ë—ñ–∑–Ω–µ—Å —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–æ!");
            showBusinesses(); // Refresh the list
            businessIndexToDelete = -1; // Reset index
            selectedBusinessIndex = -1; // Deselect any active business
        } else {
            businessIndexToDelete = -1; // Reset index if cancelled
        }
    }

    // --- Business Settings Modal ---
    function showBusinessSettingsModal() {
        document.getElementById('businessSettingsModal').style.display = 'flex';
    }


    // Initial load logic
    window.onload = () => {
      applySettings(); // Apply saved settings first
      showScreen("welcomeScreen"); // Ensure welcome screen is shown on load
    };
  </script>
</body>
</html>